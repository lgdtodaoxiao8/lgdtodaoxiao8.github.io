// Объект для работы с валидацией форм
const formValidation = {
    // Метод для настройки валидации формы
    validateForm(formId, rules) {
        const form = document.getElementById(formId);
        if (!form) return;

        // Добавляем слушатель события отправки формы
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            let isValid = true;

            // Проверяем каждое поле по заданным правилам
            Object.keys(rules).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const value = field.value.trim();
                const rule = rules[fieldId];
                
                // Если поле не прошло валидацию, показываем ошибку
                if (!rule.validate(value)) {
                    this.showError(fieldId, rule.message);
                    isValid = false;
                }
            });

            // Если форма валидна, отправляем её
            if (isValid) {
                this.submitForm(form);
            }
        });
    },

    // Метод для отображения сообщений об ошибках
    showError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const existingError = field.parentNode.querySelector('.error-message');
        if (existingError) existingError.remove();

        // Создаем элемент с сообщением об ошибке
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        
        // Добавляем сообщение об ошибке после поля
        field.parentNode.insertBefore(errorDiv, field.nextSibling);
        field.classList.add('error');
        
        // Удаляем сообщение об ошибке через 3 секунды
        setTimeout(() => {
            errorDiv.remove();
            field.classList.remove('error');
        }, 3000);
    },

    // Метод для обработки отправки формы
    submitForm(form) {
        const formData = new FormData(form);
        const data = {};
        // Очищаем данные перед отправкой
        formData.forEach((value, key) => data[key] = security.sanitizeInput(value));
        
        if (Object.values(data).some(value => value === '')) {
            alert('Обнаружен потенциально опасный ввод!');
            return;
        }
        
        console.log('Безопасные данные:', data);
        alert('Форма успешно отправлена!');
        form.reset();
    },

    // Метод для защиты от XSS-атак
    escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
};

// Объект для работы с поиском рецептов
const recipeSearch = {
    // Инициализация поиска
    init() {
        const searchInput = document.getElementById('recipe-search');
        if (searchInput) {
            searchInput.addEventListener('input', e => this.filterRecipes(e.target.value));
        }
    },

    // Метод фильтрации рецептов
    filterRecipes(query) {
        // Очищаем поисковый запрос
        query = security.sanitizeInput(query.toLowerCase());
        document.querySelectorAll('.recipes-grid article').forEach(recipe => {
            const text = recipe.textContent.toLowerCase();
            recipe.style.display = text.includes(query) ? 'block' : 'none';
        });
    }
};

// Инициализация всех компонентов при загрузке страницы
document.addEventListener('DOMContentLoaded', () => {
    // Настройка валидации для формы контактов
    formValidation.validateForm('contact-form', {
        'name': {
            validate: value => value.length >= 2,
            message: 'Имя должно содержать минимум 2 символа'
        },
        'email': {
            validate: value => /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(value),
            message: 'Введите корректный email'
        },
        'message': {
            validate: value => value.length >= 10,
            message: 'Сообщение должно содержать минимум 10 символов'
        }
    });

    // Настройка валидации для формы рецепта
    formValidation.validateForm('recipe-form', {
        'recipe-name': {
            validate: value => value.length >= 3,
            message: 'Название рецепта должно содержать минимум 3 символа'
        },
        'ingredients': {
            validate: value => value.length >= 10,
            message: 'Добавьте больше ингредиентов'
        },
        'instructions': {
            validate: value => value.length >= 50,
            message: 'Инструкция должна быть более подробной'
        }
    });

    // Инициализация поиска рецептов
    recipeSearch.init();
});

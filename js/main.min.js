// –û–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ñ–æ—Ä–º
const formValidation = {
    // –ú–µ—Ç–æ–¥ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ñ–æ—Ä–º—ã
    validateForm(formId, rules) {
        const form = document.getElementById(formId);
        if (!form) return;

        // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å —Å–æ–±—ã—Ç–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            let isValid = true;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –ø–æ–ª–µ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º –ø—Ä–∞–≤–∏–ª–∞–º
            Object.keys(rules).forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const value = field.value.trim();
                const rule = rules[fieldId];
                
                // –ï—Å–ª–∏ –ø–æ–ª–µ –Ω–µ –ø—Ä–æ—à–ª–æ –≤–∞–ª–∏–¥–∞—Ü–∏—é, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                if (!rule.validate(value)) {
                    this.showError(fieldId, rule.message);
                    isValid = false;
                }
            });

            // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –≤–∞–ª–∏–¥–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ—ë
            if (isValid) {
                this.submitForm(form);
            }
        });
    },

    // –ú–µ—Ç–æ–¥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ—à–∏–±–∫–∞—Ö
    showError(fieldId, message) {
        const field = document.getElementById(fieldId);
        const existingError = field.parentNode.querySelector('.error-message');
        if (existingError) existingError.remove();

        // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± –æ—à–∏–±–∫–µ
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ—Å–ª–µ –ø–æ–ª—è
        field.parentNode.insertBefore(errorDiv, field.nextSibling);
        field.classList.add('error');
        
        // –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            errorDiv.remove();
            field.classList.remove('error');
        }, 3000);
    },

    // –ú–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    submitForm(form) {
        const formData = new FormData(form);
        const data = {};
        // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
        formData.forEach((value, key) => data[key] = security.sanitizeInput(value));
        
        if (Object.values(data).some(value => value === '')) {
            alert('–û–±–Ω–∞—Ä—É–∂–µ–Ω –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –æ–ø–∞—Å–Ω—ã–π –≤–≤–æ–¥!');
            return;
        }
        
        console.log('–ë–µ–∑–æ–ø–∞—Å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', data);
        alert('–§–æ—Ä–º–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
        form.reset();
    },

    // –ú–µ—Ç–æ–¥ –¥–ª—è –∑–∞—â–∏—Ç—ã –æ—Ç XSS-–∞—Ç–∞–∫
    escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
};

// –û–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–∏—Å–∫–æ–º —Ä–µ—Ü–µ–ø—Ç–æ–≤
const recipeSearch = {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
    init() {
        const searchInput = document.getElementById('recipe-search');
        if (searchInput) {
            searchInput.addEventListener('input', e => this.filterRecipes(e.target.value));
        }
    },

    // –ú–µ—Ç–æ–¥ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤
    filterRecipes(query) {
        // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
        query = security.sanitizeInput(query.toLowerCase());
        document.querySelectorAll('.recipes-grid article').forEach(recipe => {
            const text = recipe.textContent.toLowerCase();
            recipe.style.display = text.includes(query) ? 'block' : 'none';
        });
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    formValidation.validateForm('contact-form', {
        'name': {
            validate: value => value.length >= 2,
            message: '–ò–º—è –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞'
        },
        'email': {
            validate: value => /^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/.test(value),
            message: '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email'
        },
        'message': {
            validate: value => value.length >= 10,
            message: '–°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 10 —Å–∏–º–≤–æ–ª–æ–≤'
        }
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è —Ñ–æ—Ä–º—ã —Ä–µ—Ü–µ–ø—Ç–∞
    formValidation.validateForm('recipe-form', {
        'recipe-name': {
            validate: value => value.length >= 3,
            message: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞'
        },
        'ingredients': {
            validate: value => value.length >= 10,
            message: '–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤'
        },
        'instructions': {
            validate: value => value.length >= 50,
            message: '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ–π'
        }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤
    recipeSearch.init();
});

// –¢–µ–º–∞: –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–ª–æ–π/—Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
(function() {
    const btn = document.getElementById('theme-toggle');
    const darkCss = document.getElementById('dark-theme-css');
    if (!btn || !darkCss) return;
    function setTheme(dark) {
        darkCss.disabled = !dark;
        btn.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', dark ? 'dark' : 'light');
    }
    const dark = localStorage.getItem('theme') === 'dark';
    setTheme(dark);
    btn.onclick = function() {
        setTheme(darkCss.disabled);
    };
})();
